<p-toolbar styleClass="mb-6">
  <ng-template #start>
    <div class="flex items-center gap-2">
      <p-button
        icon="pi pi-arrow-left"
        variant="outlined"
        severity="contrast"
        rounded
        (click)="navigateToStudent()"
      ></p-button>
      <span class="text-2xl font-bold">Detalles del Dictamen</span>
    </div>
  </ng-template>
  <ng-template #end>
    <div class="flex gap-2">
      <p-button
        label="Actualizar datos"
        icon="pi pi-refresh"
        [outlined]="true"
        [disabled]="isLoading"
        [loading]="isLoading"
        (click)="refreshReportDetails()"
      />
    </div>
  </ng-template>
</p-toolbar>

<div
  *ngIf="!reportSelected"
  class="card flex items-center justify-center py-8"
>
  <i class="pi pi-spinner pi-spin text-4xl text-primary"></i>
  <span class="ml-2 text-lg">Cargando...</span>
</div>

<div
  *ngIf="!isLoading && !reportSelected"
  class="card flex flex-col items-center justify-center py-12"
>
  <i class="pi pi-chart-line mb-4 text-6xl text-gray-400"></i>
  <h3 class="mb-2 text-xl font-semibold text-gray-600">No hay datos disponibles</h3>
  <p class="mb-4 text-center text-gray-500">No se encontraron reportes para este estudiante.</p>
</div>

<div
  class="card grid"
  *ngIf="reportSelected"
>
  <div class="flex w-full flex-col gap-1">
    <div class="mb-2 grid grid-cols-12 items-center gap-6">
      <div class="col-span-12 md:col-span-6">
        <div
          *ngIf="isLoadingImage"
          class="flex items-center justify-center py-8"
        >
          <i class="pi pi-spinner pi-spin text-4xl text-primary"></i>
          <span class="ml-2 text-lg">Cargando imágenes...</span>
        </div>
        <p-galleria
          *ngIf="!isLoadingImage && reportSelectedImages.length > 0"
          [value]="reportSelectedImages"
          [containerStyle]="{ 'max-width': '640px' }"
          [circular]="true"
          [showIndicators]="true"
          [showThumbnails]="false"
          [showItemNavigators]="true"
        >
          <ng-template
            pTemplate="item"
            let-item
          >
            <img
              *ngIf="item.loaded && item.objectUrl"
              [src]="item.objectUrl"
              style="width: 100%; height: 400px; display: block; object-fit: contain"
            />
            <div
              *ngIf="!item.loaded"
              class="flex flex-col items-center justify-center rounded bg-gray-100"
              style="width: 100%; height: 400px"
            >
              <i class="pi pi-image mb-3 text-6xl text-gray-400"></i>
              <span class="px-4 text-center text-gray-500">Error al cargar imagen</span>
              <span class="mt-1 break-all px-4 text-center text-xs text-gray-400">
                {{ item.url.split('/').pop() }}
              </span>
            </div>
          </ng-template>
        </p-galleria>
        <div
          *ngIf="!isLoadingImage && reportSelectedImages.length === 0"
          class="flex h-64 items-center justify-center rounded bg-gray-50"
        >
          <div class="text-center">
            <i class="pi pi-image mb-2 text-4xl text-gray-400"></i>
            <p class="text-gray-500">No hay imágenes disponibles</p>
          </div>
        </div>
      </div>
      <div class="col-span-12 md:col-span-6">
        <div class="mb-2 text-lg xs:text-xl">
          <span class="font-semibold">Nombre:</span>
          {{ reportSelected.student.name }} {{ reportSelected.student.firstSurname }}
          {{ reportSelected.student.secondSurname }}
        </div>
        <div class="mb-2 text-lg xs:text-xl">
          <span class="font-semibold">Matrícula:</span>
          {{ reportSelected.student.studentCode }}
        </div>
        <div class="mb-2 text-lg xs:text-xl">
          <span class="font-semibold">Número de teléfono:</span>
          {{ reportSelected.student.phoneNumber }}
        </div>
        <hr />
        <div class="mb-2 text-lg xs:text-xl">
          <span class="font-semibold">Probabilidad de consumo:</span>
          {{ reportSelected.student.predictionResult }}
        </div>
        <div class="mb-2 text-lg xs:text-xl">
          <b>Fecha de análisis:</b>
          {{ reportSelected.createdAt | date: 'dd/MM/yyyy hh:mm:ss a' }}
        </div>
        <div class="mb-2 text-lg xs:text-xl">
          <b>Temperatura:</b>
          {{ reportSelected.temperature }}°C
        </div>
        <div class="mb-2 text-lg xs:text-xl">
          <b>Frecuencia cardiaca:</b>
          {{ reportSelected.heartRate }} ppm
        </div>
        <div class="mb-2 text-lg xs:text-xl">
          <b>Presión arterial:</b>
          {{ reportSelected.systolicBloodPressure }}/{{ reportSelected.diastolicBloodPressure }} mmHg
        </div>
      </div>
    </div>
  </div>
</div>

<div class="card mt-8">
  <div class="mb-5 text-center">
    <span class="text-lg font-bold">Evolución de signos vitales</span>
  </div>
  <div
    *ngIf="isLoading"
    class="card flex items-center justify-center py-8"
  >
    <i class="pi pi-spinner pi-spin text-4xl text-primary"></i>
    <span class="ml-2 text-lg">Cargando...</span>
  </div>

  @if (!isLoading && reports && reports.length > 0) {
    <div class="min-w-[800px]">
      <p-chart
        type="line"
        [data]="chartData"
        [options]="chartOptions"
        class="h-[70rem] w-full"
        (onDataSelect)="selectReport($event)"
      ></p-chart>
    </div>
    <p-paginator
      (onPageChange)="onPageChange($event)"
      [first]="first"
      [rows]="rows"
      [totalRecords]="totalRecords"
    />
  } @else if (!isLoading) {
    <div class="flex flex-col items-center justify-center rounded bg-gray-50 py-12">
      <i class="pi pi-chart-line mb-3 text-4xl text-gray-400"></i>
      <span class="text-gray-500">No hay suficientes datos para mostrar en la gráfica</span>
    </div>
  }
</div>

<p-toast />
